<?php
  session_start();
  if (!$_SESSION['admin']) {
    header("Location: admin_login.php");
  }
  include 'koneksi.php';
  $q  = mysqli_query($conn, "SELECT saldo FROM users WHERE id = {$_SESSION['user_id']}") or die(mysqli_error($conn));
  $saldo = mysqli_fetch_array($q);
  $users  = mysqli_query($conn, "SELECT id, username FROM users WHERE id != {$_SESSION['user_id']}") or die(mysqli_error($conn));
  $empty_amount = '';
  $success_transfer = '';
  if (isset($_POST['submit'])) {
    $from = $_SESSION['user_id'];
    $to = $_POST['to'];
    $amount = $_POST['amount'];
    if ((int)$amount == 0) {
      $empty_amount = "Amount is required";
    } else {
      mysqli_autocommit($conn, FALSE);
      $query_saldo_form  = mysqli_query($conn, "SELECT saldo FROM users WHERE id = {$from}") or die(mysqli_error($conn));
      $query_saldo_to  = mysqli_query($conn, "SELECT saldo FROM users WHERE id = {$to}") or die(mysqli_error($conn));
      $saldo_form = mysqli_fetch_array($query_saldo_form);
      $saldo_to = mysqli_fetch_array($query_saldo_to);
      $sawl = (int)$saldo_form['saldo']-$amount;
      $sahr = (int)$saldo_to['saldo'] + $amount;
      $up_from  = mysqli_query($conn, "UPDATE users SET saldo={$sawl} WHERE id={$from}") or die(mysqli_error($conn));
      $up_to  = mysqli_query($conn, "UPDATE users SET saldo={$sahr} WHERE id={$to}") or die(mysqli_error($conn));
      if (!mysqli_commit($conn)) {
        echo "Commit transaction failed";
        die;
      }
      mysqli_close($con);
      header("Refresh:0");
    }
  }
?><!DOCTYPE html>
<html lang="en">

<head>
	<title>Admin Page</title>
	<meta http-equiv="content-type" content="text/html;charset=utf-8" />
</head>

<body>
	
	<h1 style="text-align: center">My Blog</h1>
	<hr>
	
	<div style="text-align: center">
		<?php if (isset($_SESSION['admin']) && $_SESSION['admin'] == 1) : ?>
			<a href="admin.php">Admin</a> | 
			<a href="transfer.php">Tansfer</a> | 
		<?php endif; ?>
		<a href="index.php">Home</a> | 
		<a href="gb.php">Guestbook</a> |
		<a href="tz.php">Cek TimeZone</a> |
		<a href="admin_logout.php">Logout</a>
	</div>
	
	<hr>	
	
	<h3>Halaman Transfer</h3>
  <p>Hi, <b><?= $_SESSION['username'] ?></b>!</p>
  <p>Saldo Kamu Sebesar
    <h1 id="saldo">
      <?= "Rp " . number_format($saldo['saldo'], 2, ',', '.') ?>
    </h1>
  </p>

  <h1 style="color: green;"><?= $success_transfer ?></h1>
	
	<form action="" method="post">
    <div>
      <label>Transfer to account:
        <select name="to">
          <?php 
            while($row = mysqli_fetch_array($users)) {
              echo "<option value=".$row['id'].">".$row['username']."</option>";
            }
          ?> 
        </select> 
      </label>
    </div>
    <br>
    <div>
      <?= $empty_amount ?><br>
      <label>Amount: <input type="text" name="amount" value=""></label>
    </div>
    <br>
    <div>
      <input type="submit" name="submit" value="Transfer">
    </div>
  </form>
	
</body>

</html>
